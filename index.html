<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="SxzZn87uR4TBl9SPhOZBWG9xDWxWMQ-BYZpEGILwAwY" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§è±ªå·å…±å’Œå›½ å•†å“æƒ…å ±</title>
    <meta name="description" content="å¤§è±ªå·å…±å’Œå›½ã®å•†å“æƒ…å ±ãƒãƒ¼ã‚¿ãƒ«ã‚µã‚¤ãƒˆã§ã™ã€‚å›½æ°‘ã®å‡ºå“æƒ…å ±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å…¬é–‹ä¸­ã€‚">
    <style>
        :root {
            --mc-green: #3cfb00;
            --mc-aqua: #55ffff;
            --mc-gold: #ffaa00;
            --cyber-bg: #0d0d0d;
            --panel-bg: rgba(20, 20, 20, 0.9);
        }

        body {
            background-color: var(--cyber-bg);
            background-image:
                linear-gradient(0deg, transparent 24%, rgba(255, 255, 255, .03) 25%, rgba(255, 255, 255, .03) 26%, transparent 27%),
                linear-gradient(90deg, transparent 24%, rgba(255, 255, 255, .03) 25%, rgba(255, 255, 255, .03) 26%, transparent 27%);
            background-size: 40px 40px;
            color: #eee;
            font-family: 'Consolas', 'Courier New', monospace;
            margin: 0; padding: 20px;
        }

        .header { text-align: center; padding: 20px 0 40px; }
        .header h1 { color: var(--mc-gold); font-size: 2.2rem; text-shadow: 0 0 15px var(--mc-gold); margin: 0; letter-spacing: 4px; }

        .main-container { display: grid; grid-template-columns: 1fr 350px; gap: 25px; max-width: 1200px; margin: 0 auto; }

        section {
            background: var(--panel-bg); border: 1px solid #333; padding: 25px;
            border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); margin-bottom: 25px;
        }

        h2 { font-size: 1.1rem; margin-top: 0; display: flex; align-items: center; gap: 10px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .stats-item { margin-bottom: 15px; }
        .bar-bg { background: #000; border-radius: 10px; height: 12px; overflow: hidden; border: 1px solid #444; margin-top: 5px; }
        .bar-fill { height: 100%; transition: width 0.8s ease-in-out; }

        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #888; font-size: 0.75rem; border-bottom: 2px solid #333; padding: 10px; }
        td { padding: 14px 10px; border-bottom: 1px solid #222; font-size: 0.9rem; }

        .coordinate { color: var(--mc-aqua); font-weight: bold; }
        .price { color: var(--mc-green); font-weight: bold; }
        .seller-tag { color: #777; font-size: 0.8rem; }

        .btn-order {
            background: transparent; border: 1px solid var(--mc-aqua); color: var(--mc-aqua);
            padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.75rem;
        }
        .btn-order:hover { background: var(--mc-aqua); color: #000; }

        .auth-panel { border: 1px solid var(--mc-gold); position: sticky; top: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 12px; margin-top: 20px; }
        input, select { background: #000; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 4px; font-family: inherit; }
        
        .btn-submit {
            background: var(--mc-gold); color: #000; border: none; padding: 15px;
            font-weight: bold; cursor: pointer; transition: 0.2s; text-transform: uppercase;
        }
        .btn-submit:disabled { background: #555; cursor: not-allowed; }
        
        .order-list { margin-top: 20px; border-top: 1px solid #444; padding-top: 15px; }
        .order-item { background: #1a1a1a; padding: 10px; margin-bottom: 8px; border-left: 3px solid var(--mc-gold); font-size: 0.8rem; }
        .btn-logout { background: #ff4444; color: #fff; border: none; padding: 8px; font-size: 0.7rem; cursor: pointer; width: 100%; margin-top: 10px; }

        #login-form, #user-dashboard { display: none; }
        @media (max-width: 900px) { .main-container { grid-template-columns: 1fr; } .auth-panel { position: static; } }
    </style>
</head>
<body>

<header class="header"><h1>å¤§è±ªå· å•†å“æƒ…å ±</h1></header>

<div class="main-container">
    <main>
        <section id="stats-panel">
            <h2 style="color: var(--mc-aqua);">ğŸ“Š å¸‚å ´æµé€šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h2>
            <div id="stats-container"></div>
        </section>

        <section>
            <h2 style="color: var(--mc-aqua);">ğŸ›’ å•†å“æ¤œç´¢</h2>
            <div class="controls">
                <input type="search" id="search-box" placeholder="å•†å“åã‚„å‡ºå“è€…ã§æ¤œç´¢..." oninput="renderTable()">
                <select id="sort-select" onchange="renderTable()">
                    <option value="newest">æ–°ç€é †</option>
                    <option value="price-asc">ä¾¡æ ¼ã®å®‰ã„é †</option>
                    <option value="price-desc">ä¾¡æ ¼ã®é«˜ã„é †</option>
                </select>
            </div>
            <table>
                <thead>
                    <tr><th>å“ç›®</th><th>å˜ä¾¡</th><th>åº§æ¨™</th><th>çŠ¶æ³</th><th>å‡ºå“è€…</th><th>æ“ä½œ</th></tr>
                </thead>
                <tbody id="trade-tbody"></tbody>
            </table>
        </section>
    </main>

    <aside>
        <section class="auth-panel">
            <div id="login-form">
                <h2 style="color: var(--mc-gold);">ğŸ” å›½æ°‘ãƒ­ã‚°ã‚¤ãƒ³</h2>
                <div class="input-group">
                    <input type="text" id="auth-mcid" placeholder="MCID">
                    <input type="password" id="id-auth-pass" placeholder="èªè¨¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
                    <button class="btn-submit" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
                </div>
            </div>

            <div id="user-dashboard">
                <h2 style="color: var(--mc-gold);">âš’ï¸ ç®¡ç†ãƒ‘ãƒãƒ«</h2>
                <p id="welcome-msg" style="font-size: 0.8rem; color: var(--mc-aqua); margin-bottom: 10px;"></p>
                
                <div class="input-group" style="margin-bottom: 20px;">
                    <h3 style="font-size: 0.8rem; color: #888; margin: 0;">æ–°è¦å‡ºå“ãƒ»æ›´æ–°</h3>
                    <input type="text" id="in-name" placeholder="å•†å“å">
                    <input type="text" id="in-price" placeholder="ä¾¡æ ¼(KD)">
                    <input type="text" id="in-coords" placeholder="åº§æ¨™(X / Z)">
                    <select id="in-stock">
                        <option value="åœ¨åº«ã‚ã‚Š">åœ¨åº«ã‚ã‚Š</option>
                        <option value="åœ¨åº«åƒ…å°‘">åœ¨åº«åƒ…å°‘</option>
                        <option value="å—æ³¨ç”Ÿç”£">å—æ³¨ç”Ÿç”£</option>
                    </select>
                    <input type="text" id="hp_field" style="display:none !important;" tabindex="-1" autocomplete="off">
                    <button class="btn-submit" id="submit-btn" onclick="submitTrade()">æƒ…å ±ã‚’ç™»éŒ²ãƒ»æ›´æ–°</button>
                </div>

                <div class="order-list">
                    <h3 style="font-size: 0.9rem; color: var(--mc-gold);">ğŸ“© å±Šã„ãŸæ³¨æ–‡</h3>
                    <div id="received-orders"><p style="font-size: 0.7rem; color: #666;">èª­ã¿è¾¼ã¿ä¸­...</p></div>
                </div>
                <button class="btn-logout" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </section>
    </aside>
</div>

<script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbwt92KOgVp4nH2qqOlt2a9yK7Pb8FYcHpYNZTZPtbH3mYbPbhfWbppjGAGBvx9YyF65Zw/exec";
    const CITIZENS = ["nyokki1958", "daran0289", "maikuraumai", "kenti7599", "SoftMusic096337", "TempOwl79825726", "SlightSum8834", "yutakabicchi", "shotaro shizoka", "Tankichi1", "Sora3055", "ShabbyRuby54641", "yuisyunn", "kiri5620", "xRqmuzzzL YT", "WoodedTuba82716", "atatan3", "Ezipt3697", "y3ur1lala", "Harukaze4006", "RinRin404040", "takubon0114", "ZeroPlayer1396", "K1hoOIE", "Hikaru bp", "kemi114", "PaltryCow795892", "haruson7856", "BleakDread23911", "FleeingRat43895", "Nnz0313", "shuji12324", "haruhi8395", "utte75877", "InlandVeil18339", "BlahColt4486", "kitune0510", "MIYUKI20107577", "HardPigeon4047", "PairedLand4913", "hiyorispyair", "DueMite4591", "yukiharu518817", "kouk9690", "Ram1117enter", "GCsTanzanite", "haha70473", "Raika6605", "hagetarouSP", "tesuteru", "tantanmendesu29", "Commander129632", "RINEshinki3030", "kanade0905", "mike32Ch", "xTZxJP"];

    let currentData = { products: [], orders: [] }; 
    let currentUser = JSON.parse(localStorage.getItem('daigoshu_user')) || null;
    let lastSubmitTime = 0;
    async function loadTradeData() {
        try {
            const res = await fetch(GAS_URL + "?t=" + Date.now());
            const data = await res.json();
            
            currentData.products = (data.products || []).map(p => ({
                name: p.name || "---",
                price: p.price || "0",
                coords: p.coords || "---",
                stock: p.stock || "ä¸æ˜",
                seller: p.seller || "anonymous"
            }));
            
            currentData.orders = data.orders || [];
            renderTable();
            updateStats(currentData.products);
            renderOrders();
        } catch (e) { console.error("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—", e); }
    }

    function renderTable() {
        const tbody = document.getElementById('trade-tbody');
        const search = document.getElementById('search-box').value.toLowerCase();
        const sort = document.getElementById('sort-select').value;
        
        let filtered = currentData.products.filter(d => 
            d.name.toLowerCase().includes(search) || d.seller.toLowerCase().includes(search)
        );
        
        if (sort === "price-asc") filtered.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
        else if (sort === "price-desc") filtered.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));

        tbody.innerHTML = filtered.map(item => `
            <tr>
                <td><strong>${item.name}</strong></td>
                <td class="price">${item.price} KD</td>
                <td class="coordinate">${item.coords}</td>
                <td style="font-size:0.8rem;">${item.stock}</td>
                <td class="seller-tag">${item.seller}</td>
                <td><button class="btn-order" onclick="placeOrder('${item.seller}', '${item.name}')">æ³¨æ–‡</button></td>
            </tr>
        `).join('');
    }
    async function submitTrade() {
        if (!currentUser) return;
        const now = Date.now();
        if (now - lastSubmitTime < 20000) { alert("é€£æŠ•é˜²æ­¢ã®ãŸã‚20ç§’å¾…ã£ã¦ãã ã•ã„"); return; }
        
        const payload = {
            action: "updateProduct",
            seller: currentUser.mcid,
            password: currentUser.pass,
            name: document.getElementById('in-name').value,
            price: document.getElementById('in-price').value,
            coords: document.getElementById('in-coords').value,
            stock: document.getElementById('in-stock').value,
            hp_field: document.getElementById('hp_field').value
        };

        if (!payload.name) return alert("å•†å“åã¯å¿…é ˆã§ã™ã€‚");

        const btn = document.getElementById('submit-btn');
        try {
            btn.disabled = true; btn.innerText = "é€ä¿¡ä¸­...";
            const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
            const result = await res.json();
            if (result.status === "success") {
                lastSubmitTime = Date.now();
                alert("æ›´æ–°å®Œäº†ï¼");
                loadTradeData();
            } else { alert("ã‚¨ãƒ©ãƒ¼: " + result.message); }
        } catch (e) { alert("é€ä¿¡å¤±æ•—"); } finally {
            btn.disabled = false; btn.innerText = "æƒ…å ±ã‚’ç™»éŒ²ãƒ»æ›´æ–°";
        }
    }

    async function placeOrder(seller, productName) {
        const buyer = prompt("ã‚ãªãŸã®MCIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if (!buyer) return;
        try {
            await fetch(GAS_URL, { 
                method: "POST", 
                body: JSON.stringify({ action: "placeOrder", buyer, seller, productName, timestamp: new Date().toLocaleString("ja-JP") }) 
            });
            alert("æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼");
            loadTradeData();
        } catch (e) { alert("æ³¨æ–‡å¤±æ•—"); }
    }

    async function deleteOrder(orderId) {
        if (!confirm("å–å¼•å®Œäº†ã¨ã—ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
        try {
            const res = await fetch(GAS_URL, { 
                method: "POST", 
                body: JSON.stringify({ action: "deleteOrder", orderId, seller: currentUser.mcid, password: currentUser.pass }) 
            });
            const result = await res.json();
            if(result.status === "success") loadTradeData();
        } catch (e) { alert("å‰Šé™¤å¤±æ•—"); }
    }

    function updateStats(data) {
        const container = document.getElementById('stats-container');
        if(!container) return;
        const counts = { "åœ¨åº«ã‚ã‚Š": { n: 0, c: "#3cfb00" }, "åœ¨åº«åƒ…å°‘": { n: 0, c: "#ffaa00" }, "å—æ³¨ç”Ÿç”£": { n: 0, c: "#55ffff" } };
        data.forEach(d => { if(counts[d.stock]) counts[d.stock].n++; });
        container.innerHTML = Object.keys(counts).map(key => {
            const val = counts[key];
            const prc = data.length > 0 ? Math.round((val.n / data.length) * 100) : 0;
            return `<div class="stats-item"><span>${key} (${val.n}ä»¶)</span><div class="bar-bg"><div class="bar-fill" style="width:${prc}%; background:${val.c};"></div></div></div>`;
        }).join('');
    }

    function renderOrders() {
        const container = document.getElementById('received-orders');
        if (!currentUser || !container) return;
        const myOrders = currentData.orders.filter(order => order.seller === currentUser.mcid);
        container.innerHTML = myOrders.length === 0 ? '<p style="font-size: 0.7rem; color: #666;">ç¾åœ¨ã€æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>' : 
        myOrders.map(order => `
            <div class="order-item">
                <div style="font-size:0.7rem; color:#888;">${order.timestamp}</div>
                <div><b>${order.buyer}</b> â†’ ${order.productName}</div>
                <button onclick="deleteOrder('${order.id}')" style="color:#ff4444; background:none; border:none; cursor:pointer; font-size:0.7rem;">[å®Œäº†ãƒ»å‰Šé™¤]</button>
            </div>
        `).join('');
    }

    function checkAuth() {
        const loginForm = document.getElementById('login-form');
        const dashboard = document.getElementById('user-dashboard');
        if (currentUser) {
            loginForm.style.display = 'none'; dashboard.style.display = 'block';
            document.getElementById('welcome-msg').innerText = `å›½æ°‘ID: ${currentUser.mcid}`;
            renderOrders();
        } else {
            loginForm.style.display = 'block'; dashboard.style.display = 'none';
        }
    }

    function login() {
        const mcid = document.getElementById('auth-mcid').value;
        const pass = document.getElementById('id-auth-pass').value;
        if (!CITIZENS.includes(mcid)) { alert("å›½æ°‘ãƒªã‚¹ãƒˆã«ã‚ã‚Šã¾ã›ã‚“"); return; }
        currentUser = { mcid, pass };
        localStorage.setItem('daigoshu_user', JSON.stringify(currentUser));
        checkAuth();
    }

    function logout() { localStorage.removeItem('daigoshu_user'); currentUser = null; checkAuth(); }

    checkAuth(); loadTradeData(); setInterval(loadTradeData, 30000);
</script>

